generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  password  String?
  image     String?
  provider  String?   // google, kakao, credentials
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]
}

model Project {
  id             String        @id @default(uuid())
  title          String
  type           String
  description    String
  status         String        @default("draft")
  stage          String        @default("research") // research, outline, write, edit, review
  outline        String?       // JSON stored as string
  targetAudience String?
  targetLength   Int?          // 목표 페이지 수
  tone           String?       // 문체/어투
  confirmedAt    DateTime?     // 목차 확정 시간
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  chapters       Chapter[]
  coverImage     CoverImage?
  researchData   ResearchData?
  editHistory    EditHistory[]
  sourceFile     SourceFile?
}

model SourceFile {
  id         String   @id @default(uuid())
  projectId  String   @unique
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fileName   String
  fileType   String   // 'txt' | 'docx' | 'pdf'
  fileSize   Int
  rawContent String   // 원본 텍스트 전체
  createdAt  DateTime @default(now())
}

model ResearchData {
  id          String   @id @default(uuid())
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  initialIdea String   // 초기 아이디어
  aiQuestions String   // JSON: AI가 생성한 질문들
  userAnswers String   // JSON: 사용자 답변들
  findings    String   // JSON: 리서치 결과
  references  String   // JSON: 참고 자료
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EditHistory {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  chapterId     String?
  type          String   // suggestion, revision, approval, rejection
  agent         String   // editor, critic, editor-critic
  beforeContent String?
  afterContent  String
  feedback      String?
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@index([chapterId])
}

model Chapter {
  id        String   @id @default(uuid())
  number    Int
  title     String
  content   String
  status    String   @default("pending")
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pages     Page[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, number])
}

model Page {
  id         String   @id @default(uuid())
  chapterId  String
  chapter    Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  pageNumber Int
  content    String
  status     String   @default("empty") // empty, draft, complete
  wordCount  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([chapterId, pageNumber])
  @@index([chapterId])
}

model CoverImage {
  id        String   @id @default(uuid())
  projectId String   @unique
  imageUrl  String
  prompt    String?
  template  String?
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
